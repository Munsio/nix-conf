---
description: Codebase
---

# Project Architecture

This is a NixOS configuration project with Home-Manager integration, using a flake setup.

- `flake.nix` is the entry point of the configuration. It defines the inputs (like `nixpkgs`, `home-manager`, etc.), outputs (NixOS and home-manager configurations), and supported systems. It defines a `whirl` NixOS host and a `gust` home-manager configuration.
- `hosts` contains the machine-specific configurations.
  - `default.nix` contains common configurations applied to all hosts, like default timezone, locale, and system packages.
  - `whirl/` and `gust/` are directories for specific hosts. Each contains:
    - `default.nix`: (in `whirl`) a NixOS configuration for that host, specifying hardware-specific settings and enabling NixOS modules.
    - `home.nix`: A home-manager configuration for that host, enabling specific home-manager modules, features, and bundles. It can also contain host-specific overrides for settings.
    - `variables.nix`: Defines host-specific variables like timezone, locale, keyboard layout, and the NixOS state version.
    - `hardware-configuration.nix`: (in `whirl`) contains the hardware-specific configuration for the machine, generated by NixOS.
- `home` contains the user-specific and application configurations, managed by home-manager.
  - `default.nix` is the main entry point for home-manager configurations. It dynamically discovers and imports modules from the `features`, `bundles`, and `services` directories, making them available to be enabled in host configurations.
  - `features/`: This directory contains individual, modular configurations for specific applications and tools. For example, `git.nix` configures git aliases and settings, and `hyprland.nix` configures the Hyprland window manager. Each file is a self-contained Nix expression that defines the configuration for a single feature.
  - `bundles/`: This directory contains files that group multiple features and services together. For example, `hypr-desktop.nix` enables the `hyprland`, `hyprlock`, `hyprpaper`, and other related features to provide a complete desktop environment. This allows for easy installation and management of complex setups.
  - `services/`: This directory contains configurations for background services. For example, `clipman.nix` enables the `clipman` clipboard manager. These are similar to features but are specifically for services that run in the background.
- `lib/default.nix`: This file contains helper functions for the rest of the configuration.
- `shell.nix`: This file provides backward compatibility for older Nix versions that don't support flakes.
- `statix.toml`: This is a configuration file for the Statix linter, which is used to check the Nix code for errors and anti-patterns.
- `.envrc`: This is a file used by `direnv` to set up the development environment when you enter the project directory.
- `modules/`: This directory contains NixOS modules that can be enabled in the configuration.
- `overlays/`: This directory contains overlays, which are used to add or modify packages in `nixpkgs`.
- `users/`: This directory contains user-specific configurations. Each user has a subdirectory with their name, which contains a `home.nix` and `default.nix` file.

# Key Concepts and Design Philosophy

This section explains the reasoning behind the structure of this Nix configuration.

### Modularity

The configuration is designed to be highly modular, separating concerns into distinct, reusable units:

- **`features/`**: Contains small, atomic configurations for a single tool or application (e.g., `git.nix`, `neovim.nix`). Each file should be self-contained and represent a single piece of functionality.
- **`services/`**: Holds configurations for background processes or daemons (e.g., `clipman.nix`, `hypridle.nix`). These are distinct from features as they run continuously in the background.
- **`bundles/`**: Groups multiple features and services together into a cohesive experience. For example, `hypr-desktop.nix` combines the Hyprland window manager, a status bar, a lock screen, and other utilities to create a complete desktop environment. This prevents configuration duplication and makes it easy to enable a full suite of tools at once.

### Host-specific vs. User-specific Configuration

A clear separation is maintained between machine-level settings and user-specific preferences:

- **`hosts/`**: Manages configurations that are tied to a specific machine. This includes hardware drivers, network settings, system-level packages, and defining which bundles or features are enabled on that machine.
- **`users/`**: Manages user-specific dotfiles, secrets, and personal identity. This allows a user's personal configuration to be applied across different hosts.

### The Role of `lib/default.nix`

The `lib/default.nix` file contains helper functions designed to reduce boilerplate and simplify the management of the configuration:

- `mkSystem`: A function that abstracts away the complexity of creating a full NixOS system configuration. It automatically includes the necessary modules, overlays, and user configurations.
- `mkHome`: A similar function for creating standalone home-manager configurations that are not tied to a NixOS system.

# Usage and Workflows

This section provides a practical guide for common tasks.

### How to Add a New NixOS Host

1.  **Create Host Directory**: Create a new directory under `hosts/` with the desired hostname (e.g., `hosts/new-machine/`).
2.  **Add Configuration Files**: Inside the new directory, create the following files:
    - `default.nix`: For NixOS-specific settings (hardware, services, etc.).
    - `home.nix`: For home-manager settings specific to this host.
    - `variables.nix`: To define host-specific variables (timezone, locale, etc.).
3.  **Add to Flake**: In `flake.nix`, define the new host within the `nixosConfigurations` set using the `mkSystem` helper function.
4.  **Deploy**: Run `sudo nixos-rebuild switch --flake .#new-machine` on the target machine.

### How to Add a New User

1.  **Create User Directory**: Create a directory under `users/` with the username (e.g., `users/new-user/`).
2.  **Add User Configuration**: Inside the new directory, add `default.nix` and `home.nix` to define the user's base configuration.
3.  **Assign to Host**: In `flake.nix`, add the new username to the `users` list within the desired host's `mkSystem` definition.

### How to Add a New Application (Feature)

1.  **Create Feature File**: Create a new file in `home/features/` (e.g., `home/features/my-app.nix`).
2.  **Write Configuration**: Write the home-manager configuration for the application inside this new file.
3.  **Enable Feature**: To enable the application, add `homeModules.my-app.enable = true;` to a `home.nix` file, either for a specific host (`hosts/my-host/home.nix`) or for a user (`users/my-user/home.nix`).

### How to Apply Changes

- **Full NixOS System Rebuild**: `sudo nixos-rebuild switch --flake .#<hostname>`
- **Home-Manager Only**: `home-manager switch --flake .#<username>@<hostname>` or `home-manager switch --flake .#<home-configuration-name>`

# Overlays and Package Management

The `overlays/` directory is used to customize the Nix package set (`nixpkgs`). This allows you to add new packages, modify existing ones, or override their default versions.

For example, to add an unstable package to your otherwise stable system, you could create a `unstable-packages.nix` overlay. The `flake.nix` file then makes these overlays available to the system configurations.
